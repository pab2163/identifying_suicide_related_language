---
title: 'Youth Suicide Lexicon Validation By Participant'
author: "Paul Alexander Bloom"
date: "2025-04-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(caret)
library(ggplot2)
library(stringr)
library(cowplot)
source('helper_functions.R')
```

# Load MAPS validation dataframe
```{r}
load('../model_outputs_step1/data_for_maps_validation.rda')

table(maps_validation_df$swaminathan_thoughtsmethods_flag)


bysub_summary = maps_validation_df %>%
                   group_by(subjectID) %>%
  summarise(n = n(),
            true_rate = sum(suicide_related)/n) %>%
  ungroup() %>%
  mutate(deid = as.character(sprintf("%02d", row_number(subjectID))))
  
# Remove one participant with no true positives (can't be analyzed in isolation)
bysub = maps_validation_df %>%
  dplyr::filter(subjectID != 'no_true_positives') %>%
  group_by(subjectID) %>%
  nest() %>%
  mutate(stats = purrr::map(data, ~evaluate_predictions(maps_validation_df = 
                                                                     mutate(., suicide_related = factor(suicide_related, levels = c("0", "1"))), 
                                                        reference_col='suicide_related', 
                                                        positive_class = '1',
                                                        prediction_cols = c('lexicon_only_flag', 'low_srl_flag', 
                                                                          'swaminathan_thoughtsmethods_flag'))))
# Nest data and calculate model stats by participant
bysub_stats = bysub %>%
  dplyr::select(-data) %>%
  unnest(stats)  %>%
  left_join(., bysub_summary, by = 'subjectID') %>%
  ungroup() %>%
  mutate(
         subjectID = as.character(subjectID),
         label = paste0('Participant ', deid, ' (N=', n, ' entries, ', 
                        format(round(true_rate*100, 2), nsmall=2), '% true positives)')) %>%
  mutate(PredictionColumn = dplyr::recode(PredictionColumn,
                                         'low_srl_flag'='Low 2024\nLexicon',
                                         'lexicon_only_flag'='Youth Suicide\nLexicon',
                                         'swaminathan_thoughtsmethods_flag'=' Swaminathan 2023\nLexicon'
                                         ))
# Plot model stats by participant
validation_maps_bysub = ggplot(bysub_stats, aes(x = PredictionColumn, y = F1, color = label)) +
  geom_point() +
  geom_line(aes(group = label)) +
  theme_bw() +
  labs(color = 'Participant', y = 'F1 Score') 


ggsave(validation_maps_bysub, file = '../figures/supplemental/step1_validation_bysub.png',
       height = 4, width = 7)

```

